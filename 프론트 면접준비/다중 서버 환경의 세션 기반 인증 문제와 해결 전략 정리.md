
# 다중 서버 환경의 세션 기반 인증: 문제와 해결 전략 정리

> 요약: 로드 밸런싱 하에서 **세션이 서버별로 국소 저장**되면 **세션 불일치**가 발생합니다. 해결책은 (1) **스티키 세션**, (2) **세션 클러스터링(복제)**, (3) **외부 스토리지 분리**이며, 트래픽 패턴·장애 허용·운영 복잡도에 따라 선택합니다.

---

## 1) 문제 정의: 세션 불일치(Session Affinity Mismatch)
- 사용자가 로그인하면 **서버 A**에만 세션이 생성·저장.
- 이후 요청이 **서버 B**로 라우팅되면 B에는 세션이 없어 **인증 실패/재인증** 발생.
- 증상: 간헐적 로그아웃, 인증 필요 페이지 리디렉션 루프, API 401/403.

---

## 2) 해결 전략 3가지

### 2.1 스티키 세션(Sticky Session, Session Affinity)
**개념**
- 로드 밸런서가 **특정 식별자**(세션 쿠키, IP 해시 등)에 따라 **항상 동일 서버**로 라우팅.
- 일반적으로 L7 LB에서 **세션 쿠키 기반**(예: `AWS ALB stickiness`, `Nginx ip_hash/cookie` 등).

**장점**
- 구성 **간단**, 코드 변경 불필요.
- 세션이 **로컬 메모리**에만 존재하므로 접근 지연이 가장 낮음.

**단점/리스크**
- **트래픽 쏠림**: 특정 유저군이 한 서버에 집중 → 불균형/핫스팟.
- **서버 다운 시 사용자 로그아웃**(그 서버에만 세션 존재).
- **오토스케일링/롤링 배포** 시 세션 지속성 관리가 번거로움.
- IP 기반은 NAT/모바일 환경에서 **불안정**.

**적합도**
- 소규모, 상태 작은 세션, 고속 응답이 필요한 **단순 구성**에 적합.
- 고가용성 요구가 높으면 한계가 분명.

---

### 2.2 세션 클러스터링(Session Replication)
**개념**
- 각 서버가 **세션을 상호 복제**(메모리 → 메모리). 애플리케이션/컨테이너 레벨의 **in-memory replication**(예: 톰캣 클러스터링, Hazelcast, Infinispan 등).

**장점**
- **서버 장애에도 세션 유지**(다른 노드에 복제본 존재).
- 스티키 필요성 낮음(어느 노드로 가도 세션 존재).

**단점/리스크**
- **메모리 사용량 증가**(노드 수 × 세션 크기).
- **복제 트래픽** 오버헤드, 네트워크 지연 시 **일시적 불일치** 가능.
- 노드가 늘수록 **복잡도/확장 한계**(N^2 복제 토폴로지 이슈).

**적합도**
- 노드 수가 **소수**이고 세션이 **작고 수명 짧은** 환경.
- 데이터 센터 간 복제에는 부적합(지연/트래픽).

---

### 2.3 스토리지 분리(Externalized Session Store)
**개념**
- 세션을 **외부 공유 스토리지**(예: **Redis**, Memcached, RDB 등)에 저장.
- 모든 앱 서버는 **stateless**에 가깝게 동작, 로드 밸런서는 자유롭게 분산.

**장점**
- **수평 확장성** 우수(노드 증감 영향 적음).
- 서버 교체/배포/장애에 **세션 소실 없음**.
- 세션 조작(만료, 강제 로그아웃, 블랙리스트) **중앙화** 관리.

**단점/리스크**
- 스토리지의 **단일 장애 지점(SPOF)** → 클러스터링/레플리카로 HA 필수.
- 외부 호출 오버헤드(네트워크 RTT)와 **운영 복잡성**(모니터링/백업/튜닝).
- 복제/샤딩 환경에서 **일시적 불일치** 가능.

**적합도**
- **표준 해법**: 마이크로서비스/오토스케일, 다중 AZ/리전, 롤링 배포 빈번한 환경.
- 세션이 크거나 TTL 정책이 까다로운 서비스에도 유연.

---

## 3) 비교 요약

| 항목 | 스티키 세션 | 세션 클러스터링 | 스토리지 분리 |
|---|---|---|---|
| 구현 난이도 | 낮음 | 중간 | 중~높음 |
| 장애 내성 | 낮음(고정 노드 다운 시 영향) | 중간(복제본) | 높음(스토리지 HA 전제) |
| 확장성(노드 증가) | 낮음(쏠림) | 중간(복제 비용 증가) | 높음 |
| 성능(평균 지연) | 매우 낮음(로컬) | 낮음(로컬 접근+복제) | 중간(네트워크 호출) |
| 운영 복잡도 | 낮음 | 중간(복제/토폴로지) | 높음(클러스터/모니터링) |
| 배포 민첩성 | 낮음 | 중간 | 높음 |
| 주요 리스크 | 쏠림, 노드 장애시 세션 소실 | 메모리·네트워크 비용, 일시적 지연 | SPOF/복잡성, 비용 |

---

## 4) 선택 가이드
- **초기/소규모**: 트래픽 균질·장애 허용 낮음 → **스티키 세션**으로 빠르게 시작 가능.
- **중간 규모/온프렘**: 노드 수 제한·LAN 내 통신 원활 → **세션 클러스터링** 고려.
- **클라우드·대규모**: 오토스케일/무중단 배포/멀티 AZ 필수 → **외부 세션 스토어(권장)**.

---

## 5) 실무 팁
- **세션 크기 최소화**: 직렬화 비용/네트워크 비용/복제 비용 절감.
- **TTL/슬라이딩 만료** 정책 명확화(유휴 시간, 절대 만료 동시 관리).
- **CSRF/XSS** 대비: 세션 ID는 추측 불가·Secure/HttpOnly/SameSite 쿠키 설정.
- **로그아웃/강제 만료**: 중앙 저장소라면 키 삭제·블랙리스트 즉시 반영.
- **헬스체크/드레인**: 스케일 인/배포 시 세션 만료까지 **연결 드레인**(graceful) 전략.
- **관측성**: 세션 수, 히트율, 스토리지 RTT, 에러율, 복제 지연, eviction 지표 모니터링.
- **암호화/서명**: 세션 페이로드가 민감하면 저장 전 암호화 또는 최소 키만 저장.

---

## 6) 대안 짧게: 토큰 기반(JWT 등)
- 서버 세션 상태를 없애 **완전 무상태**로 운영 가능(로드 밸런싱 자유도 ↑).
- 단, **무효화·회수**(revocation)와 **길이/보안** 이슈가 있으므로
  - **짧은 TTL + 리프레시 토큰**,
  - 서버 측 **블랙리스트/세션 인덱스** 병행을 검토.

---

## 결론
- 다중 서버에서의 세션 불일치는 구조적으로 자연스러운 문제입니다.  
- **요구사항(가용성/확장/운영 부담)** 을 기준으로 3가지 전략을 비교하여 선택하고, 세션 최소화·관측성·보안 헤더 등 **운영 수칙**을 병행하면 안정적으로 확장할 수 있습니다.
