# CDN(Content Delivery Network) 정리

## 1) 개념

CDN은 전 세계에 분산된 **엣지(Edge) 서버**를 통해 정적/반정적 콘텐츠를 **사용자와 물리적으로 가까운 위치**에서 제공하여 지연 시간을 줄이고, 원본(Origin) 서버의 부하를 감소시키는 분산 전송 기술입니다.

## 2) 작동 원리(요약)

1. **DNS/Anycast 라우팅**: 사용자의 요청이 지리·네트워크적으로 가까운 엣지로 유도됩니다.
2. **캐시 적중(Cache Hit)**: 엣지에 콘텐츠가 있으면 즉시 응답합니다.
3. **캐시 미스(Cache Miss)**: 엣지에 없으면 원본에서 가져와 저장한 뒤 사용자에게 전달합니다.
4. **TTL/무효화 정책**에 따라 갱신·삭제하며 일관성을 유지합니다.

## 3) 핵심 이점

- **지연 시간 단축**: 거리·홉 수 감소로 TTFB와 전송 지연을 줄입니다.
- **원본 부하 완화**: 엣지 캐시가 반복 요청을 흡수합니다.
- **스케일 및 안정성**: 대규모 트래픽·플래시 크라우드에도 대응합니다.
- **보안 강화**: TLS 종료, DDoS 완화, WAF, 봇 차단 등과 연계가 쉽습니다.
- **비용 최적화**: 원본 egress 절감 및 서버 스펙 요구치 하향이 가능합니다.

## 4) 언제 적용하나

- **글로벌 사용자**를 대상으로 할 때
- **대용량 정적 리소스**(이미지/동영상/JS/CSS/폰트 등) 제공 시
- **이벤트성 트래픽 급증**이 예상될 때
- **원본 가용성/복구력**을 높이고 싶을 때

## 5) 구성 요소

- **엣지(POP)**: 캐시·TLS 종료·압축·리라이트 등을 수행합니다.
- **원본(Origin)**: 애플리케이션 서버, 오브젝트 스토리지(S3 등) 등입니다.
- **DNS/라우팅**: 지리 기반·Anycast로 최적 POP로 유도합니다.
- **제어면(Control Plane)**: 캐시 정책·무효화·보안 규칙을 관리합니다.

## 6) 캐싱 전략·무효화

- **Cache-Control**: `max-age`, `s-maxage`, `immutable`, `stale-while-revalidate` 등을 적절히 설정합니다.
- **ETag/Last-Modified**로 조건부 요청을 활용합니다.
- **파일 핑거프린팅(버저닝)**: `app.abcdef.js`처럼 해시를 붙여 장기 캐시 + 안전한 교체를 구현합니다.
- **선택적 퍼지(무효화)**: 경로/태그 단위로 필요한 리소스만 갱신합니다.
- **오리진 실드(Origin Shield)**: 상위 캐시를 두어 원본 요청을 더 줄입니다.

## 7) 동적·개인화 콘텐츠

- **캐시 불가 데이터**는 패스스루하되, HTML은 **Edge Side Includes(ESI)**, **캐시 키 분리(Vary/Cookie/헤더)**, **부분 캐싱**으로 가능성을 모색합니다.
- **에지 컴퓨팅(Functions/Workers)**으로 리다이렉트, A/B 테스트, 헤더 가공, 경량 API 응답 등을 POP에서 처리해 TTFB를 줄입니다.
- **이미지/동영상 최적화**: 엣지에서 포맷 변환(WebP/AVIF), 리사이즈, 압축, 적응형 비트레이트(HLS/DASH) 등을 수행합니다.

## 8) 보안 포인트

- **TLS 종단 및 재암호화**: 엣지에서 HTTPS 종료 후 원본까지 다시 HTTPS 권장.
- **WAF/DDoS 방어**: L3~L7 보호, 레이트 리밋, 챌린지 적용.
- **서명 URL/쿠키**: 프라이빗 콘텐츠 접근 제어.
- **BOT 방지·IP 평판**: 악성 트래픽 억제.

## 9) 비용·주의사항

- **에그레스 과금**: POP 지역/전송량에 따라 상이, 핫 오브젝트는 장기 캐시로 완화합니다.
- **캐시 일관성**: TTL 과도 증가 시 구버전 노출, 과도 감소 시 원본 부하 증가—비즈니스 특성에 맞춰 균형을 잡아야 합니다.
- **퍼지 지연**: 전 세계 POP 전파에 지연이 있을 수 있으므로 해시 버저닝을 기본으로 합니다.
- **원본 보호**: 엣지 우회 방지를 위해 **Origin Access Control/전용 헤더/프라이빗 엔드포인트**를 사용합니다.

## 10) 구현 체크리스트

- [ ] 정적 자산 빌드 시 **파일 해시** 붙이기
- [ ] HTML은 짧은 TTL + `stale-while-revalidate`, 정적 자산은 긴 TTL + `immutable`
- [ ] `Accept`/`User-Agent`/`Cookie` 등 **캐시 키 설계** 명확화
- [ ] 이미지 **리사이즈·포맷 자동화**(WebP/AVIF)와 **CDN 이미지 서비스** 사용
- [ ] **오리진 실드/프록시 캐시**로 원본 보호
- [ ] **WAF/DDoS, HTTPS 강제, HSTS** 적용
- [ ] 장애 대비 **오리진 헬스 체크**와 **대체 원본(Failover Origin)** 구성

## 11) 간단 아키텍처 흐름

사용자 → DNS/Anycast → 가장 가까운 **엣지 POP** → (캐시 히트면 즉시 응답 / 미스면) **오리진**에서 가져와 저장 → 응답.
