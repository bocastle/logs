# HTTP 메서드의 멱등성(Idempotency) 정리

> **멱등성**은 **동일한 요청을 1회 수행한 결과와 N회 수행한 결과가 동일**함을 의미합니다.  
> HTTP에서 멱등성은 **서버의 최종 상태**가 동일하게 유지되는지를 기준으로 판단합니다.

---

## 1) 메서드별 멱등성/안전성 요약

| 메서드      | 멱등성  | 안전성(Safe) | 비고                                                                                                   |
| ----------- | ------- | ------------ | ------------------------------------------------------------------------------------------------------ |
| **GET**     | ✔       | ✔            | 조회만 수행(서버 상태 불변). 로그 증가 같은 **부수효과**는 허용되지만 안전성 판단에 영향 없음.         |
| **HEAD**    | ✔       | ✔            | GET과 동일하되 바디 없음.                                                                              |
| **OPTIONS** | ✔       | ✔            | 통신 가능 옵션 질의.                                                                                   |
| **TRACE**   | ✔       | ✔            | 요청 루프백. 보안상 차단하는 환경 많음.                                                                |
| **PUT**     | ✔       | ✖            | **대상 리소스를 주어진 표현으로 대체**. 동일 요청 반복 시 결과 동일. 201/200/204 등 반환 가능.         |
| **DELETE**  | ✔       | ✖            | 첫 삭제 이후 추가 DELETE는 **효과 없음**(리소스가 없음을 유지) → 멱등으로 간주.                        |
| **POST**    | ✖(기본) | ✖            | **리소스 생성/액션 트리거** 등 누적 효과가 일반적 → **비멱등**. 단, **설계/키**에 따라 멱등 구현 가능. |
| **PATCH**   | △       | ✖            | 부분 변경. **연산 정의에 따라** 멱등 또는 비멱등(예: `replace`는 멱등, `increment`는 비멱등).          |

> **안전성(Safe)**: 서버 상태를 변경하지 않는 성질. 멱등성과는 별개입니다(멱등하나 안전하지 않을 수 있음: PUT/DELETE).

---

## 2) 멱등성이 중요한 이유(활용)

- **재시도 판단 기준**: 네트워크 단절/타임아웃 시 **클라이언트가 안심하고 재요청**할 수 있음.
- **분산 시스템 신뢰성**: 로드밸런서/리트라이 미들웨어/메시지 재전달에서 **중복 수신**을 안전하게 처리.
- **Exactly‑once 착시 제거**: 실무에서는 최소 **at‑least‑once 전달**을 보장하고, **멱등 처리**로 최종 일관성을 확보.

---

## 3) 멱등 POST 구현(패턴)

POST 자체는 기본적으로 비멱등이지만, 아래 기법으로 **멱등 POST**를 설계할 수 있습니다.

### 3.1 Idempotency‑Key

- 클라이언트가 **요청 단위 고유 키**(예: UUID, 결제 토큰)를 헤더나 바디로 전달:
  - 예: `Idempotency-Key: 7c0e1c0c-...`
- 서버는 **키 → 결과**를 **멱등 저장소**에 매핑하여, **중복 요청 시 동일 응답**을 반환.
- TTL/정책: **중복 허용 기간**(예: 24시간), **요청 바디 해시**까지 함께 저장하여 **키 재사용 오남용 방지**.

### 3.2 자연 키(업서트)

- 자원 식별자가 **자연스럽게 유일**할 때 PUT/POST를 **Upsert**로 설계:
  - 예: `/orders/{orderId}` 에 **PUT** → 동일 `orderId`로 **N회 호출해도 최종 상태 동일**.

### 3.3 조건부 요청

- `If-Match`/`If-None-Match`(ETag), `If-Modified-Since` 등으로 **조건 불일치 시 실패** 처리 → **중복/경쟁 방지**.

---

## 4) PUT vs POST vs PATCH — 멱등 관점 설계

- **PUT**: 대상의 **전체 표현을 대체** → 멱등. 일부 필드만 갱신하려면 명시적 규칙 필요.
- **PATCH**: **연산 의미**에 따라 다름. RFC 6902(JSON Patch)의 `replace`는 멱등, `add`는 적용 위치에 따라 비멱등, `increment`는 비멱등.
- **POST**: 생성/액션 트리거가 보통 → 비멱등. 단, **Idempotency‑Key**로 멱등화 가능.

---

## 5) 상태 코드와 멱등성

- **201 Created**: 리소스가 새로 생성됨(첫 요청에서만). 중복 요청은 **200/303/409** 등으로 처리 가능.
- **200/204**: 멱등 재요청에서 동일 결과 반환.
- **409 Conflict**: **동일 의미의 생성**을 **다른 키**로 반복 시 충돌로 거절.
- **412 Precondition Failed**: 조건부 요청 실패(ETag/전제조건 위반).

---

## 6) 클라이언트/서버 책임 분담(재시도 설계)

### 클라이언트

- **네트워크 오류/타임아웃** 시 **재시도 정책**(지수 백오프+지터) 적용.
- **멱등 키 전송**(POST 멱등화) 및 **요청 바디 해시** 포함.
- **재시도 데드라인**(총 시간 예산)과 **멱등 키 재사용 기간** 준수.

### 서버

- **멱등 저장소**(키→응답) 구축, 요청 본문 해시 검증.
- **사이드 이펙트 분리**: 로그/푸시 등은 **중복 안전하게** 처리.
- **트랜잭션 경계**: DB/외부 시스템 호출에서 **정확히 한 번**이 아니라 **멱등하게** 보장.

---

## 7) 결제 예시(간단 흐름)

1. 클라이언트가 `Idempotency-Key`와 결제 요청 바디 전송.
2. 서버는 키가 **처음**이면 결제 시도 → 성공 시 **응답과 상태를 키에 저장**.
3. 동일 키로 재요청 시, **보관된 동일 응답**을 즉시 반환(중복 청구 방지).

---

## 8) 흔한 오해/주의점

- **멱등 ≠ 부수효과 없음**: 로깅/모니터링 카운트 증가 등은 허용. **서버 상태(리소스의 의미)** 가 동일하면 멱등입니다.
- **캐싱과 혼동 금지**: 멱등은 **서버 상태의 불변**에 관한 성질이고, 캐싱은 **응답 재사용**에 관한 정책입니다.
- **DELETE의 멱등성**: ‘존재하지 않음’을 유지하므로 멱등. 단, **부수 시스템**(연관 캐시/인덱스)이 중복 삭제에도 안전해야 함.
- **멀티 리전/다중 소비자**: 메시지 중복 수신을 **전제**하고 서버 측 멱등 처리를 구현하십시오.

---

## 9) 실무 체크리스트

- [ ] API별 **멱등/비멱등**을 문서에 명시했는가
- [ ] **POST 멱등화**가 필요한 경로에 **Idempotency‑Key**를 도입했는가
- [ ] **PUT/PATCH 규칙**(전체 대체 vs 부분 변경)을 일관되게 정의했는가
- [ ] **상태 코드**(201/200/204/409/412)를 시나리오에 맞게 사용하고 있는가
- [ ] **재시도 정책**(백오프+지터, 데드라인)이 구현되어 있는가
- [ ] **서버 측 중복 방지 저장소**(키→응답, 본문 해시)가 운영 중인가
- [ ] **트랜잭션/외부 호출**에 대해 멱등 처리를 보장했는가(업서트/유니크 키/컨디셔널 업데이트)
- [ ] **관측/경보**: 중복 시도·키 충돌·409/412 추이를 모니터링하는가

---

## 10) 요약

- 멱등성은 **동일 요청의 반복이 서버의 최종 상태를 바꾸지 않는 성질**입니다.
- GET/HEAD/OPTIONS/TRACE/PUT/DELETE는 **원칙적으로 멱등**, POST는 **기본 비멱등**(설계로 멱등화 가능), PATCH는 **정의에 따라 다름**입니다.
- **재시도·분산 환경**의 기본 가정이므로, **Idempotency‑Key**, **업서트**, **조건부 요청** 등으로 멱등 설계를 체계화하십시오.
