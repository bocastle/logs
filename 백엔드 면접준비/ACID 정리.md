# ACID 정리

> 요약: 트랜잭션이 **안전하게 수행**되도록 보장하는 네 가지 성질 — **원자성(Atomicity)**, **일관성(Consistency)**, **격리성(Isolation)**, **지속성(Durability)** — 의 약자입니다. RDBMS는 로그, 잠금/버전, 제약조건, 체크포인트 등으로 이를 충족합니다.

---

## 1) ACID 네 가지 속성

### 1.1 원자성 (Atomicity)

- **모두 수행하거나(All) 전혀 수행하지 않음(Nothing)** 을 보장합니다.
- 중간 단계에서 오류가 나면 **롤백(undo)** 되어 트랜잭션 이전 상태로 복구됩니다.
- 예: 계좌 이체(출금 + 입금). 입금 실패 시 출금도 취소.

### 1.2 일관성 (Consistency)

- 트랜잭션이 끝나면 **DB 불변식/제약조건**(PK/UK/FK, CHECK, 도메인 규칙, 트리거 등)이 **항상 성립**해야 합니다.
- 규칙을 위반하면 트랜잭션은 **실패·롤백**되어 **일관된 상태**만 유지됩니다.
- 예: 잔액 음수 금지, FK 무결성, 총합 보존 규칙 등.

### 1.3 격리성 (Isolation)

- 동시에 실행되는 트랜잭션이 **서로 간섭 없이** 실행되도록 합니다.
- 격리 수준(READ UNCOMMITTED → READ COMMITTED → REPEATABLE READ → SERIALIZABLE)에 따라 **허용되는 이상 현상**(Dirty/Non-repeatable/Phantom Read)이 달라집니다.
- 가장 강한 SERIALIZABLE은 **논리적 순차 실행**과 같은 결과를 보장합니다.

### 1.4 지속성 (Durability)

- 커밋된 결과는 **영구히 보존**되어야 하며, 장애 이후에도 **손실되지 않음**을 보장합니다.
- 일반적으로 **WAL(Write-Ahead Logging)**, **체크포인트**, **리두(redo) 로그**로 구현됩니다.

---

## 2) 계좌 이체 예시로 보는 ACID

1. `BEGIN`
2. A 계좌 **출금 -3000**
3. B 계좌 **입금 +3000**
4. **제약조건 검증**(잔액 ≥ 0, FK 등) → 위반 시 **롤백**(Atomicity/Consistency)
5. **커밋** → 로그 디스크 반영(초기 fsync 정책에 따름) (Durability)
6. 동시 실행 중 다른 트랜잭션은 중간 합계가 보이지 않음(Isolation)

---

## 3) DB가 ACID를 보장하는 핵심 메커니즘

- **원자성**: WAL의 **undo/redo** 기록, 트랜잭션 경계 관리, 실패 시 **롤백**.
- **일관성**: **제약조건/트리거** 평가, 참조 무결성, 도메인 규칙, 커밋 시점 검증.
- **격리성**:
  - **잠금 기반**(S/X/의도락, 레코드락, 갭락/넥스트키락)
  - **MVCC**(스냅샷 읽기, 버전 타임스탬프)로 읽기-쓰기 충돌 완화 및 팬텀 억제.
- **지속성**: 커밋 시 **로그 우선 기록 → 체크포인트** → 장애 시 **크래시 리커버리**.

---

## 4) 격리 수준과 이상 현상 요약

| 격리 수준        | Dirty Read | Non-Repeatable Read | Phantom Read                                    |
| ---------------- | ---------- | ------------------- | ----------------------------------------------- |
| READ UNCOMMITTED | 가능       | 가능                | 가능                                            |
| READ COMMITTED   | 불가       | 가능                | 가능                                            |
| REPEATABLE READ  | 불가       | 불가                | 구현에 따라 **대체로 불가**(InnoDB: 넥스트키락) |
| SERIALIZABLE     | 불가       | 불가                | 불가                                            |

> 주의: DBMS별 구현 차이가 있습니다(예: InnoDB의 REPEATABLE READ는 넥스트키락으로 팬텀을 방지).

---

## 5) 실무 주의점 & 모범사례

- **트랜잭션 경계 최소화**: 필요한 로직만 포함하여 잠금 유지 시간을 단축.
- **명시적 격리 수준** 선택: 성능과 정합성 요구를 균형. 보고/조회는 RC, 금전 거래는 RR/Serializable 등.
- **오류 처리 표준화**: 예외 시 **롤백** 확실히, 재시도 정책(Deadlock/Timeout)에 대한 **idempotency 키** 고려.
- **Durability 정책**: `synchronous_commit`, `innodb_flush_log_at_trx_commit` 등 **fsync 정책**을 SLO/성능과 맞춤.
- **제약조건으로 Consistency를 DB에 위임**: 애플리케이션 레벨 검증만으로는 경쟁 상태를 막기 부족.
- **장기 트랜잭션 지양**: MVCC 버전 누적/가비지 지연, 락 경합 증가 유발.

---

## 6) 흔한 오해

- **ACID = 느림**: 꼭 그렇지 않습니다. 적절한 인덱스/격리 수준/배치 처리로 고성능과 정합성을 **동시에** 달성할 수 있습니다.
- **일관성은 앱에서만 보장**: DB 제약조건을 활용하지 않으면 경쟁 상황에서 쉽게 깨집니다.
- **Durability는 커밋이면 끝**: 스토리지/로그 동기화 정책이 다르면 전원 장애에서 **손실 가능성**이 달라집니다.

---

## 7) 체크리스트

- [ ] 트랜잭션 경계(`BEGIN/COMMIT/ROLLBACK`)가 **명확**한가.
- [ ] 필요한 **제약조건**이 DB에 선언되어 있는가.
- [ ] 적합한 **격리 수준**을 선택했고, 성능 영향 평가를 했는가.
- [ ] **로그/체크포인트/백업/복구** 전략이 SLO를 만족하는가.
- [ ] **데드락 재시도/타임아웃** 정책과 멱등 처리 흐름이 있는가.

---

## 결론

ACID는 트랜잭션 정합성의 **기초 체계**입니다. 애플리케이션 요구사항(정합성 SLO, 성능, 가용성)에 따라 **격리 수준과 Durability 정책**을 조정하고, **제약조건과 로그 기반 복구**를 적극 활용하면 실무에서도 안전성과 성능을 균형 있게 달성할 수 있습니다.
