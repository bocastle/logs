# TCP 3-Way Handshake 정리

> **TCP 3-Way Handshake**는 **신뢰 가능한 연결**을 수립하기 위해 **SYN → SYN+ACK → ACK** 세 단계로 세그먼트를 교환하는 절차입니다. 이 과정에서 양 단말은 **초기 순서 번호(ISN)** 를 교환하고, 옵션(MSS, 윈도우 스케일, 타임스탬프 등)을 협상합니다.

---

## 1) 단계별 흐름(기본)

```
Client                                            Server
  | -- SYN, ISN=c, wnd, MSS, WS, TS -----> |
  | <--- SYN+ACK, ISN=s, ACK=c+1 ---------- |
  | -- ACK, ACK=s+1 ----------------------> |
(연결 수립)                                 (연결 수립)
```

- **1단계(SYN)**: 클라이언트가 연결 요청과 함께 **ISN=c** 를 보냅니다.
- **2단계(SYN+ACK)**: 서버는 자신의 **ISN=s** 와 함께 **ACK=c+1** 로 응답합니다.
- **3단계(ACK)**: 클라이언트는 **ACK=s+1** 을 보내며, 이 시점에 양측은 **송·수신 시퀀스 공간**을 합의하고 **ESTABLISHED** 상태가 됩니다.

> 데이터는 보통 3단계 완료 후 전송되지만, 일부 환경에서는 **SYN에 소량 데이터**를 실을 수 있는 **TCP Fast Open(TFO)** 을 사용할 수 있습니다(상호 지원 필요).

---

## 2) 시퀀스/ACK 번호와 플래그

- **Sequence Number(SEQ)**: 바이트 단위 데이터의 **오프셋**. 초기에는 무작위에 가까운 **ISN** 으로 시작합니다.
- **ACK Number(ACK)**: **다음에 기대하는 바이트**의 시퀀스(= 마지막으로 정상 수신한 바이트 + 1).
- **플래그**: `SYN`, `ACK`, `FIN`, `RST`, `PSH`, `URG`, `ECE`, `CWR` 등.
  - Handshake에서는 주로 **SYN**, **ACK** 가 사용됩니다.

---

## 3) 옵션 협상(일반적 예)

- **MSS(Maximum Segment Size)**: 페이로드의 최대 바이트. **경로 MTU**에 근거해 파편화 없이 전송하도록 조정.
- **윈도우 스케일(Window Scale, WS)**: 수신 윈도우를 65,535 바이트 이상 확장(고대역·고지연 BDP 환경).
- **타임스탬프(TSopt)**: 고해상도 RTT 측정, PAWS 보호.
- **SACK Permitted**: **선택적 재전송(SACK)** 허용으로 손실 시 효율 개선.

> 이러한 옵션은 주로 **SYN 세그먼트**에서 교환되어 세션 동안 사용됩니다.

---

## 4) 상태 전이(간략)

- 클라이언트: `CLOSED → SYN-SENT → ESTABLISHED`
- 서버: `LISTEN → SYN-RECEIVED → ESTABLISHED`
- 양측은 수립 후 데이터 송수신 및 **흐름 제어(윈도우)** / **혼잡 제어**(Slow Start 등)를 수행합니다.

---

## 5) 동시 오픈(Simultaneous Open)

- 드물지만 양측이 동시에 `SYN` 을 보내 **교차 SYN** 이 발생할 수 있습니다.
- 절차: `SYN ↔ SYN` 교환 후 서로 **SYN+ACK** 를 보내고 **ACK** 로 마무리하여 ESTABLISHED가 됩니다.

---

## 6) 재전송·타임아웃·백로그

- **SYN 재전송(Retransmission)**: 응답이 없으면 지수 백오프 기반으로 **SYN 재전송**. OS별 횟수/시간 상한이 존재합니다.
- **백로그 큐**: 서버는 `LISTEN` 소켓당 **반개방 세션(half-open)** 을 임시로 보관합니다. 큐 포화 시 **SYN drop** 또는 타 조치가 발생할 수 있습니다.

---

## 7) 보안 고려: SYN Flood와 완화

- **SYN Flood**: 대량의 `SYN` 으로 **백로그**를 고갈시키는 공격.
- **SYN Cookies**: 백로그 대신 **ISN에 암호학적 쿠키**를 인코딩해 상태 없이 검증. **정상 ACK** 가 오면 커넥션을 정식 구축.
- 기타: **SYN Rate Limit**, **백로그 확장**, **잘못된 재전송 탐지**, **방화벽/로드밸런서**에서 전처리.

---

## 8) 연결 종료(참고: 4-Way Teardown)

- 일반적으로 **`FIN`/`ACK`** 교환으로 **반이중 종료**를 양방향으로 수행(총 4단계).
- RST(Reset)로 **비정상 즉시 종료**도 가능합니다.
- 종료 후 **TIME_WAIT**(보통 2MSL)를 통해 **지연 세그먼트 소거**와 **포트 재사용 안전성**을 보장합니다.

---

## 9) 흔한 문제와 점검 항목

- **방화벽/미들박스**로 인한 **SYN/SYN+ACK 차단** 여부
- **MSS/PMTUD** 불일치로 인한 **단편화/블랙홀** 문제
- **윈도우 스케일 미협상**으로 인한 **고지연 링크 처리량 저하**
- **재전송/타임아웃** 튜닝(클라이언트 대기 체감, 백오프 상한)
- **Fast Open** 사용 시 **쿠키 발급/호환성** 확인

---

## 10) 요약

- **3단계**: `SYN`(ISN 교환 시작) → `SYN+ACK`(상대 ISN 확인) → `ACK`(수립 확정).
- Handshake 동안 **옵션 협상**이 이뤄지며, 이후 **흐름/혼잡 제어**가 정상 작동합니다.
- 운영 환경에서는 **재전송, 백로그, 보안(SYN cookies)** 과 **MTU/MSS** 설정을 함께 점검하여 안정적인 연결 성능을 확보해야 합니다.
