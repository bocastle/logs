# 로드 밸런싱 정리

> 요약: 로드 밸런서는 클라이언트로부터 들어오는 요청을 **여러 서버로 분산**하여 **가용성, 확장성, 성능, 보안**을 확보합니다. L4/L7 위치, 헬스 체크, 세션 친화성, TLS 종료, 알고리즘 선택이 핵심입니다.

---

## 1) 로드 밸런싱이란

- 애플리케이션 앞단에서 **트래픽을 분산**해 단일 서버 과부하를 방지하고 **장애 격리** 및 **확장**을 가능하게 함.
- 일반 구성

```
[Client] → [LB] → [App Server Pool] → [DB/Cache]
```

- 레이어별
  - **L4**(TCP/UDP): 전송 계층 스위칭, 성능 우선, 컨텐츠 인지 X
  - **L7**(HTTP/HTTPS/GRPC): 애플리케이션 계층, 경로·헤더·쿠키 기반 라우팅, 세밀한 제어

---

## 2) 핵심 기능

- **헬스 체크**(TCP/HTTP/HTTPS, gRPC): 실패 시 노드 격리, 복구 시 자동 편입
- **세션 친화성(Sticky Session)**: 쿠키/IP 해시 등으로 동일 사용자를 같은 백엔드로 라우팅
- **TLS 종료/재암호화**: 인증서 중앙 관리, 백엔드 오프로딩
- **정책 라우팅**: 경로(/api, /static), 헤더, 메서드, 버전, 지역 등
- **Rate Limiting / WAF / DDoS 흡수**: L7에서 보안 정책 적용
- **커넥션 드레이닝 & 슬로우 스타트**: 배포/축소 시 안전한 트래픽 이탈

---

## 3) 대표 알고리즘과 특징

### 3.1 라운드 로빈 (Round Robin)

- **방식**: 요청을 순서대로 A→B→C→A...
- **장점**: 단순·균등 분산
- **한계**: 서버 성능/부하 차이를 반영하지 못함

### 3.2 가중치 라운드 로빈 (Weighted RR)

- **방식**: 서버별 **가중치** 비율로 더 많은 요청 배분
- **장점**: 서로 다른 스펙 고려
- **한계**: **실시간 상태**(부하, 지연)는 반영하지 못함

### 3.3 최소 연결 (Least Connections)

- **방식**: **활성 연결 수**가 가장 적은 서버 선택
- **장점**: 긴 연결/스트리밍에 유리
- **한계**: 서버 성능이 다르면 불리 → **가중치 최소 연결**로 보완

### 3.4 최소 응답 시간 (Least Response Time)

- **방식**: 최근 **지연(latency)** 이 가장 낮은 서버 선택
- **장점**: 사용자 체감 속도 개선
- **한계**: RTT 편향/짧은 관측 창 왜곡 가능

### 3.5 IP 해시 (IP Hash)

- **방식**: 클라이언트 IP 해시 → 특정 서버 매핑
- **장점**: **세션 친화성** 간단 달성
- **한계**: NAT/프록시 환경, 불균등 분산 위험

### 3.6 일관 해시 (Consistent Hashing)

- **방식**: 해시 링 기반, 노드 증감 시 **키 이동 최소화**
- **장점**: 캐시/세션 샤딩에 적합
- **한계**: 구현 복잡도, 가중치·가상노드 설계 필요

### 3.7 무작위 + 두 후보 비교 (Power of Two Choices)

- **방식**: 임의 두 서버 중 **부하가 더 낮은** 곳 선택
- **장점**: 계산량 작지만 분산 품질 우수
- **한계**: 메트릭 품질에 민감

### 3.8 큐 길이/CPU 기반 동적 스케줄링, EWMA

- **방식**: 백엔드 **큐 길이/에러율/지연의 지수 이동 평균**으로 가중치 갱신
- **장점**: 동적 상태 반영
- **한계**: 관측/수집 비용, 튜닝 필요

---

## 4) 선택 가이드

| 상황                    | 추천 알고리즘/전략                           |
| ----------------------- | -------------------------------------------- |
| 서버 스펙 동일, 단순 웹 | Round Robin → 필요 시 Weighted RR            |
| 장기 커넥션/웹소켓 많음 | Least Connections(가중치 옵션)               |
| 지연에 민감한 API       | Least Response Time / 2-Choices              |
| 세션 친화성 필요        | IP/쿠키 해시 또는 L7 쿠키 기반 Sticky        |
| 캐시 키/샤딩            | Consistent Hashing                           |
| 트래픽 급변/노이즈      | EWMA 기반 동적 가중 + 드레이닝/슬로우 스타트 |

---

## 5) 운영 모범 사례

- **헬스 체크**: 다단계 검사(포트 열림 + HTTP 200 + 의존성 상태), 실패 임계치와 재시도 백오프 설정
- **커넥션 드레이닝**: 배포/축소 시 기존 연결을 **정상 종료** 후 제거
- **슬로우 스타트**: 신규 노드에 초반 저가중치 부여, 캐시 워밍 시간 보장
- **오류 버짓/서킷 브레이커**: 실패율↑ 백엔드 임시 격리, 재가중치 조정
- **옵저버빌리티**: p95/p99 지연, 에러율, 활성 연결 수, 서킷 상태, 드롭률 대시보드
- **다중 영역/리전**: **GSLB/Anycast + AZ 로컬 LB**로 계층 분산
- **보안**: L7 WAF/Rate Limit, mTLS(내부), HSTS, TLS 정책 중앙화

---

## 6) 간단 설정 예시

### 6.1 NGINX (Weighted RR + 헬스 체크 유사 구성)

```nginx
upstream app_pool {
  zone app_pool 64k;
  least_conn;
  server app1:8080 weight=3 max_fails=3 fail_timeout=10s;
  server app2:8080 weight=1 max_fails=3 fail_timeout=10s;
}

server {
  listen 443 ssl;
  location / {
    proxy_pass http://app_pool;
    proxy_next_upstream error timeout http_502 http_503;
    proxy_connect_timeout 2s;
    proxy_read_timeout 5s;
  }
}
```

### 6.2 HAProxy (Power of Two Choices + 드레이닝)

```haproxy
backend app
  balance random(2)  # 두 후보 중 선택
  server s1 10.0.0.1:8080 check slowstart 5s
  server s2 10.0.0.2:8080 check slowstart 5s
  option httpchk GET /healthz
  http-check expect status 200
```

---

## 7) 흔한 함정

- **Sticky 남용**: 수평 확장·롤링 업데이트 시 **핫스팟** 유발 → 가능한 **무상태(stateless)** 로 전환
- **헬스 체크 오탐**: 외부 의존성(DB/캐시) 점검 누락 시 장애 감지 실패
- **단일 LB 병목**: LB 이중화(Active-Active) 및 **상위 DNS/GSLB** 준비
- **TLS 오프로딩만** 하고 백엔드 평문 고정: 내부망 노출 위험 → **백엔드 재암호화** 고려
- **가중치 고정**: 배포/스케일 변화에 따라 **동적 조정** 자동화 필요

---

## 8) 화이트보드 개념도

```
                   +-------------------+
Internet  ───────▶ |  Global LB/DNS    | ──▶  Region A LB ──▶ App A1,A2,A3
                   +-------------------+        │
                            │                    └─▶ Cache/DB
                            └────────────▶  Region B LB ──▶ App B1,B2
```

---

## 결론

- 로드 밸런싱은 **알고리즘(분산 정책) + 운영 전략(헬스·드레이닝·보안)** 의 조합입니다.
- 워크로드 특성과 SLO에 맞춰 **라우팅 기준**(성능 vs 일관성 vs 친화성)을 선택하고, 관측·자동화·안전한 배포 절차를 함께 설계해야 합니다.
