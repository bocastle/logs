# JWT 특징과 주의 사항 정리

## 1. JWT 특징

### 1) Self-contained(클레임 기반) 토큰

- JWT는 토큰 자체에 사용자/권한/만료시간 같은 **클레임(Claims)** 을 포함합니다.
- 서버가 매 요청마다 세션 저장소를 조회하지 않아도 되므로 인증/인가 흐름이 단순해질 수 있습니다.

### 2) Stateless(서버 상태 최소화)에 유리

- 서버가 “세션 상태”를 들고 있지 않아도 되므로 **수평 확장(Scale-out)** 환경에서 세션 불일치 문제가 덜합니다.
- 다만, “완전한 무상태”로 운영하면 **토큰 무효화(강제 로그아웃)** 같은 요구사항이 어려워질 수 있습니다.

### 3) 구조: Header / Payload / Signature

- **Header**: 토큰 타입, 서명 알고리즘(alg)
- **Payload**: 클레임(예: sub, exp, roles 등)
- **Signature**: 변조 방지용 서명 (Header+Payload를 비밀키/개인키로 서명)

---

## 2. JWT 주의 사항

### 1) Payload는 “암호화”가 아니라 “인코딩”일 뿐

- JWT의 일반적인 형태(JWS)는 Base64URL 인코딩이라 **디코딩이 매우 쉽습니다.**
- 따라서 **민감정보(비밀번호, 주민번호, 카드번호, 원문 PII 등)는 절대 넣지 않는 것**이 원칙입니다.
  - 민감정보를 담아야 한다면 “서명”이 아니라 **암호화(JWE)** 영역입니다.

### 2) 토큰 탈취 대응이 핵심

JWT가 유출되면, 만료(exp) 전까지는 공격자가 정상 사용자처럼 행동할 수 있습니다.  
따라서 아래를 같이 설계해야 합니다.

- **저장 위치**
  - 브라우저라면 XSS 관점에서 localStorage 저장은 위험도가 큽니다.
  - 가능하면 **HttpOnly + Secure + SameSite 쿠키** 조합을 고려합니다.
- **Refresh Token 도입 여부**
  - Access Token은 짧게, Refresh Token으로 재발급하는 방식이 일반적입니다.
- **Refresh Token Rotation**
  - 재발급 시 Refresh Token을 매번 교체하고, 이전 토큰 재사용이 감지되면 전체 세션을 폐기하는 전략이 유용합니다.
- **탈취 감지/대응**
  - UA/IP/디바이스 기반 이상 징후 탐지, 토큰 재사용 탐지, 강제 로그아웃(블랙리스트/세션화) 등을 고려합니다.

### 3) 만료 전략이 UX와 충돌할 수 있음

- Access Token 만료가 짧으면 보안은 좋아지지만 UX 문제가 발생할 수 있습니다.
  - 예: 긴 글 작성 중 만료 → 제출 시 401 → 데이터 유실
- 대응 예:
  - **슬라이딩 세션(활동 시 만료 연장)**
  - **백그라운드 리프레시(만료 임박 시 재발급)**
  - 폼 임시 저장/드래프트 저장 등 UX 보강

### 4) “무효화(Revocation)”가 어렵다

- JWT는 서버가 상태를 안 들고 가는 대신, 발급된 토큰을 **즉시 폐기**하기 어렵습니다.
- 강제 로그아웃/권한 회수/유출 대응이 필요하면 아래 중 하나가 필요합니다.
  - 토큰 블랙리스트(서버 저장소 필요)
  - jti(토큰 ID) 기반 allowlist/denylist
  - Access Token 짧게 + Refresh Token 서버 관리(세션 성격 혼합)

### 5) 키/알고리즘 관련 보안 이슈

- **약한 시크릿 키**는 브루트포스에 취약합니다 → 충분히 긴 랜덤 키 사용, 안전한 비밀 관리(Secret Manager 등)
- **alg=none 공격**: 헤더의 alg를 none으로 조작해 서명 검증 우회를 시도
  - 라이브러리 최신화 + 서버가 허용 알고리즘을 “토큰 헤더 값”이 아니라 **서버 설정으로 강제**해야 합니다.
- **알고리즘 혼동(Algorithm confusion)** 도 주의
  - 예: RS256(비대칭) 기대인데 HS256(대칭)로 바꿔치기 시도
  - 검증 시 알고리즘/키 타입을 서버에서 엄격히 고정해야 합니다.

---

## 3. 실무 체크리스트(요약)

- Payload에 민감정보 금지
- Access Token 짧게 + Refresh Token/Rotation 검토
- 저장은 가능하면 HttpOnly 쿠키 고려(XSS 대비)
- 만료 UX(슬라이딩/백그라운드 리프레시/드래프트) 같이 설계
- 허용 알고리즘을 서버에서 강제, 키는 충분히 강하게/안전하게 관리
- 강제 로그아웃/권한 회수 요구가 있으면 “무효화 전략”을 반드시 추가
